// Segment.io (c) 2013
// Feedback very welcome at friends@segment.io
(function(undefined){var op=Object.prototype;var win=window;var doc=document;var nav=navigator;var DOMReady={ready:false,callbacks:[],markReady:function(){DOMReady.ready=true;var callback=DOMReady.callbacks.pop();while(callback){callback();callback=DOMReady.callbacks.pop()}},check:function(){if(doc.readyState=="complete"||doc.addEventListener&&doc.readyState=="loaded"){DOMReady.markReady();return true}else{return false}},listen:function(){if(!this.check()){if(doc.addEventListener){doc.addEventListener("DOMContentLoaded",this.markReady,true);doc.addEventListener("readystatechange",this.check,true);win.addEventListener("load",this.markReady,true)}else{if(doc.attachEvent){doc.attachEvent("onreadystatechange",this.check);win.attachEvent("onload",this.markReady)}}}},wait:function(callback){if(this.ready){callback()}else{this.callbacks.push(callback)}}};DOMReady.listen();var Base64={keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64.utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this.keyStr.charAt(enc1)+this.keyStr.charAt(enc2)+this.keyStr.charAt(enc3)+this.keyStr.charAt(enc4)}return output},utf8_encode:function(str){var fcc=String.fromCharCode;str=str.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<str.length;n++){var c=str.charCodeAt(n);if(c<128){utftext+=fcc(c)}else if(c>127&&c<2048){utftext+=fcc(c>>6|192);utftext+=fcc(c&63|128)}else{utftext+=fcc(c>>12|224);utftext+=fcc(c>>6&63|128);utftext+=fcc(c&63|128)}}return utftext}};var jsonEncode=function(obj){var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;var quote=function(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'};var str=function(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(value&&helpers.isDate(value)){value=toISOString(value)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(op.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(op.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}};return str("",{"":obj})};var cookie={get:function(name){var index=0;if(!document.cookie.match("^"+name+"=")){index=document.cookie.indexOf("; "+name+"=");if(index!==-1){index+=2}}if(index!==-1){var end=document.cookie.indexOf(";",index);if(end===-1){end=document.cookie.length}return unescape(document.cookie.substring(index+name.length+1,end))}else{return""}},set:function(name,value,duration,domain,path,secure){value=value.toString();var cookieArray=[escape(name),"=",escape(value)];if(duration){var expiration=new Date;expiration.setDate(expiration.getDate()+duration);cookieArray.push("; expires=",expiration.toGMTString())}if(domain){cookieArray.push("; domain=",domain)}if(path){cookieArray.push("; path=",path)}if(secure){cookieArray.push("; secure")}document.cookie=cookieArray.join("")}};var ts=op.toString;var slice=Array.prototype.slice;var helpers={clone:function(obj){if(!obj)return;return this.extend({},obj)},extend:function(obj){if(!this.isObject(obj))return;var args=Array.prototype.slice.call(arguments,1);for(var i=0,source;source=args[i];i++){if(!this.isObject(source))continue;for(var property in source){obj[property]=source[property]}}return obj},clean:function(obj){var count=0;for(var prop in obj){if(!obj[prop])delete obj[prop];else count+=1}return count},keys:Object.keys||function(obj){if(obj!==Object(obj))throw new TypeError("Invalid object");var keys=[];for(var key in obj)if(op.hasOwnProperty.call(obj,key))keys[keys.length]=key;return keys},isObject:function(obj){return obj===Object(obj)},isString:function(obj){return ts.call(obj)=="[object String]"},isNumber:function(obj){return ts.call(obj)=="[object Number]"},isFunction:function(obj){return ts.call(obj)=="[object Function]"},isNaN:function(obj){return obj!==obj},isBoolean:function(obj){return obj===true||obj===false||ts.call(obj)=="[object Boolean]"},isDate:function(obj){return ts.call(obj)=="[object Date]"},isArray:Array.isArray||function(obj){return ts.call(obj)=="[object Array]"},isDefined:function(obj){return obj!==void 0},isValidPrimitiveValue:function(obj){return this.isString(obj)||this.isNumber(obj)&&!this.isNaN(obj)||this.isBoolean(obj)||this.isDate(obj)},isEmail:function(obj){return this.isString(obj)&&/\S+@\S+\.\S{2,4}/.test(obj)},now:function(){return(new Date).getTime()}};var uuid={create:function(){var S4=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return S4()+S4()+S4()+S4()}};var toISOString=function(date){function padString(value,amount){value=value.toString();amount=amount||2;while(value.length<amount){value="0"+value}return value}var year=date.getUTCFullYear(),month=padString(date.getUTCMonth()+1),days=padString(date.getUTCDate()),hours=padString(date.getUTCHours()),minutes=padString(date.getUTCMinutes()),seconds=padString(date.getUTCSeconds()),milliseconds=padString(date.getUTCMilliseconds(),3);return year+"-"+month+"-"+days+"T"+hours+":"+minutes+":"+seconds+"."+milliseconds+"Z"};var queryString={detect:function(){var output={};var search=document.location.search.substring(1);search=search.split("&");for(var i=0;i<search.length;i++){var tokens=search[i].split("=");output[tokens[0].toLowerCase()]=tokens[1]}return output}};var consoleLogger={log:function(success,message){message="[segmentio] "+message;if(success&&typeof console!=="undefined"&&console&&console.log)console.log(message);else if(typeof console!=="undefined"&&console&&console.warn)console.warn(message)}};var logger={providers:[consoleLogger],level:3,toOrdinal:function(lvl){if(lvl==="verbose"){return 0}else if(lvl==="error"){return 1}else{return 2}},addLogger:function(logProvider){this.providers.push(logProvider)},setLevel:function(lvl){this.level=this.toOrdinal(lvl)},log:function(level,success,message,id){var ordinal=this.toOrdinal(level);if(ordinal>=this.level){if(id)message="["+id+"] "+message;for(var i=0;i<this.providers.length;i+=1){this.providers[i].log(success,message)}}}};var jsonp={name:"jsonp",enabled:true,scriptTags:{},callbacks:{},supported:function(){return true},removeScriptTag:function(callbackId){if(callbackId in this.scriptTags){this.scriptTags[callbackId].parentNode.removeChild(this.scriptTags[callbackId]);this.scriptTags[callbackId]=null;delete this.scriptTags[callbackId]}},callback:function(callbackId,data){this.removeScriptTag(callbackId);if(callbackId in this.callbacks){var jsonpCallback=this.callbacks[callbackId];delete this.callbacks[callbackId];return jsonpCallback(data.success,data)}},send:function(url,properties,callback){properties.callback="segment.callback";this.callbacks[properties.callbackId.toString()]=callback;var json=jsonEncode(properties);if(json.length>1500){logger.log("error",false,"Supplied data exceeds maximum size (1500 JSON characters).",properties.callbackId);return callback(false,{code:"CHAR_LIMIT_EXCEEDED",message:"Exceeded limit of 1500 JSON characters per request."})}var base64=Base64.encode(json);base64=encodeURIComponent(base64);url+="?data="+base64;var script=document.createElement("script");script.type="text/javascript";script.async=true;script.defer=true;script.src=url;var firstScript=document.getElementsByTagName("script")[0];firstScript.parentNode.insertBefore(script,firstScript)}};var cors={name:"cors",enabled:true,supported:function(){if("XMLHttpRequest"in window){var request=new XMLHttpRequest;if("withCredentials"in request)return true;else return false}else{return false}},send:function(url,properties,callback){var self=this;var json=jsonEncode(properties);if(json.length>1500){logger.log("error",false,"Supplied data exceeds maximum size (1500 JSON characters).",properties.callbackId);return callback(false,{code:"CHAR_LIMIT_EXCEEDED",message:"Exceeded limit of 1500 JSON characters per request."})}var xhr=new XMLHttpRequest;xhr.onload=function(e){if(e&&e.target&&e.target.responseText){var success=e.target.status===200;if(!success){self.enabled=false;transport.init()}if(JSON&&JSON.parse){try{var data=JSON.parse(e.target.responseText);callback(success,data)}catch(ex){logger.log("error",false,"Failed to parse API response as json : "+e.target.responseText);callback(false,ex)}}else{callback(success,{})}}else{callback(false,e)}};xhr.open("POST",url,true);xhr.setRequestHeader("Content-Type","text/plain");xhr.send(json)}};var transport={providers:[cors,jsonp],selected:null,init:function(){for(var i=0;i<this.providers.length;i+=1){if(this.providers[i].supported()&&this.providers[i].enabled){this.selected=this.providers[i];logger.log("verbose",true,"Selected "+this.selected.name+" as API transport.");return true}}return false},send:function(url,properties,callback){return this.selected.send(url,properties,callback)}};transport.init();var utm={name:"utm",get:function(){var parsed=queryString.detect();var info={source:parsed.utm_source,medium:parsed.utm_medium,term:parsed.utm_term,content:parsed.utm_content,campaign:parsed.utm_campaign};var existingProperties=helpers.clean(info);return existingProperties>0?info:null}};var client={enabled:false,config:{baseUrl:("http:"===document.location.protocol?"http://":"https://")+"api2.segment.io",apiVersion:"v1",apiKey:null,loadedPageEventName:"Loaded a Page",cookie:{delimiter:"----",key:"_sio",duration:365*2,secure:false,path:"/"}},user:{id:null,session:null},stats:{requests:0,successful:0,failed:0,identifies:0,tracks:0,aliases:0},visitSources:[],visitContext:null,pageSources:[utm],pageContext:null,isEnabled:function(){var ua=navigator.userAgent;var disabled=/(google web preview|googlebot)/i.test(ua)||/yahoo/i.test(ua)||/bingbot/i.test(ua);return!disabled},initialize:function(apiKey,options){if(!helpers.isObject(options)){options={verbose:false}}if(!helpers.isString(apiKey)||apiKey.length===0){return logger.log("error",false,"Please call initialize with a valid apiKey string as the first argument.")}this.config.apiKey=apiKey;if(options.verbose)logger.setLevel("verbose");this.readCookie();this.enabled=this.isEnabled();if(this.enabled){this.buildContexts();if(!this.user.session||this.user.session===""){this.user.session=uuid.create();this.writeCookie()}this.track(this.config.loadedPageEventName,this.pageContext)}},readCookie:function(){var kookie=cookie.get(this.config.cookie.key);if(kookie){var tokens=kookie.split(this.config.cookie.delimiter);if(tokens.length>=1&&tokens[0]!=="")this.user.session=tokens[0];if(tokens.length>=2&&tokens[1]!=="")this.user.id=tokens[1]}},writeCookie:function(){var kookie=[this.user.session,this.user.id].join(this.config.cookie.delimiter);this.setCookie(this.config.cookie.key,kookie)},setCookie:function(name,value){var config=this.config;cookie.set(name,value,config.cookie.duration,this.cookieDomain(),config.cookie.path,config.cookie.secure)},cookieDomain:function(){var host=window.location.hostname,topLevel=host.match(/[a-z0-9][a-z0-9\-]*[a-z0-9]\.[a-z\.]{2,6}$/i);if(host==="localhost")return null;var domain=topLevel?topLevel[0]:host;return"."+domain},identify:function(id,traits,context,callback){if(id===undefined||helpers.isFunction(id)){return logger.log("error",false,"Identify must be called with either userId or {traits}.")}if(helpers.isFunction(context)){callback=context;context=undefined}if(helpers.isFunction(traits)){callback=traits;traits=undefined}var shouldIdentify=false;if(helpers.isObject(id)){traits=id;id=this.user.id}if(helpers.isNumber(id)){id=id.toString()}if(!helpers.isString(id)&&id!==null&&id!==undefined){return logger.log("error",false,"Identify requires the userId to be either a "+"string or a number.")}if(this.user.id!==id){shouldIdentify=true;if(!helpers.isEmail(id)){logger.log("verbose",true,"This userId: "+id+" doesnt appear to be an email - we recommend"+" using an email :)")}if(this.user.id)this.user.session=uuid.create();this.user.id=id;this.writeCookie()}traits=traits||{};if(!helpers.isObject(traits)||helpers.isArray(traits)||helpers.isDate(traits)){return logger.log("error",false,"Identify {traits} (second argument) must be a javascript object.")}if(helpers.keys(traits).length>0){shouldIdentify=true}if(shouldIdentify){if(this.enabled){traits=this.cleanProperties(traits);logger.log("verbose",false,["Identifying user:",this.user.id?this.user.id:"anonymous","traits:",jsonEncode(traits)].join(" "));this.request("/i",{sessionId:this.user.session,userId:this.user.id,traits:traits,context:helpers.extend({},context,this.visitContext)},callback);this.stats.identifies+=1}else{logger.log("error",false,"The segmentio client is not initialized. Either segment.initialize wasnt called, or this is a search spider.")}}else{if(helpers.isFunction(callback))callback(true)}},buildContexts:function(){this.visitContext=this.buildVisitContext();this.pageContext=this.buildPageViewProperties()},buildVisitContext:function(){var context={language:nav.language,library:"segment.js"};this.buildContext(context,this.visitSources);return context},buildPageViewProperties:function(){var properties={url:doc.location.href,referrer:doc.referrer,userAgent:nav.userAgent};this.buildContext(properties,this.pageSources);return properties},buildContext:function(context,sources){for(var i=0;i<sources.length;i+=1){if(sources[i]["get"]&&helpers.isString(sources[i].name)){var info=sources[i].get();if(info)context[sources[i].name]=info}}},track:function(event,properties,context,callback){if(helpers.isFunction(context)){callback=context;context=undefined}if(helpers.isFunction(properties)){callback=properties;properties=undefined}if(!helpers.isString(event)){var message="Track must be called with an event name "+"(string as the first argument).";logger.log("error",false,message);if(helpers.isFunction(callback)){callback(false,{message:message})}return}properties=properties||{};if(helpers.isObject(properties)){if(this.enabled){properties=this.cleanProperties(properties);logger.log("verbose",true,["Beginning track:",event,"user:",this.user.id?this.user.id:"anonymous","properties:",jsonEncode(properties)].join(" "));this.request("/t",{userId:this.user.id,sessionId:this.user.session,event:event,properties:properties,context:helpers.extend({},context,this.visitContext)},callback);this.stats.tracks+=1}else{logger.log("error",false,"The segmentio client is not initialized. Either segment.initialize wasnt called, or this is a search spider.")}}else{logger.log("error",false,"Track {properties} (second argument) must be a javascript object.")}},alias:function(from,to,context,callback){if(helpers.isFunction(to)){callback=to;to=undefined;context=undefined}if(helpers.isFunction(context)){callback=context;context=undefined}if(helpers.isObject(to)){context=to;to=null}if(!helpers.isString(from)&&helpers.isString(to)){from=this.user.id||this.user.session}if(helpers.isString(from)&&!helpers.isString(to)){to=from;from=this.user.id||this.user.session}if(!helpers.isString(from)){var fromMessage="Alias must be called with a from id"+"(string as the first argument).";logger.log("error",false,fromMessage);if(helpers.isFunction(callback)){callback(false,{message:fromMessage})}return}if(!helpers.isString(to)){var toMessage="Alias must be called with a to id"+"(string as the first argument).";logger.log("error",false,toMessage);if(helpers.isFunction(callback)){callback(false,{message:toMessage})}return}if(this.enabled){logger.log("verbose",true,["Beginning alias:","from:",from,"to:",to].join(" "));this.request("/a",{from:from,to:to,context:helpers.extend({},context,this.visitContext)},callback);this.stats.aliases+=1}else{logger.log("error",false,"The segment.io client is not initialized. Either segment.initialize wasnt called, or this is a search spider.")}},request:function(endpoint,payload,callback){var self=this;var url=this.config.baseUrl+"/"+this.config.apiVersion+endpoint;this.fillCommonPayload(payload,callback);logger.log("verbose",true,[endpoint,"started",jsonEncode(payload)].join(" "),payload.callbackId);transport.send(url,payload,function(success,data){if(success){logger.log("verbose",success,"Segment.io API call succeeded.",data.callbackId);self.stats.successful+=1}else{var errCode="CONNECT_ERR";var errMessage="Failed to connect to API endpoint.";if(data&&data.error){if(data.error.type)errCode=data.error.type;if(data.error.message)errMessage=data.error.message}var message="Segment.io API call failed; code: "+errCode+" message: "+errMessage;self.stats.failed+=1;logger.log("error",success,message,payload.callbackId)}if(callback)callback(success,data)});this.stats.requests+=1},cleanProperties:function(props,depth){if(!depth)depth=0;else if(depth>5){logger.log("error",false,"Invalid property because it has nested objects more than 4 levels deep.");return{}}var cleaned={};var keys=helpers.keys(props);for(var i=0;i<keys.length;i+=1){var key=keys[i];var val=props[key];if(val===window){logger.log("error",false,'Woah! You can not pass in the "window" object into segmentio API calls.')}else if(!helpers.isDate(val)&&!helpers.isArray(val)&&helpers.isObject(val)){var obj=this.cleanProperties(val,depth+1);if(helpers.keys(obj).length>0){cleaned[key]=obj}}else if(helpers.isArray(val)){logger.log("error",false,"Property "+key+" is invalid because it is an array")}else if(helpers.isValidPrimitiveValue(val)){cleaned[key]=val}else{logger.log("error",false,"Property "+key+" is an invalid type")}}return cleaned},fillCommonPayload:function(payload,callback){payload.apiKey=this.config.apiKey;payload.callbackId=Math.floor(Math.random()*1e3)}};var api={initialize:function(apiKey,options){return client.initialize(apiKey,options)},identify:function(id,traits,context,callback){return client.identify(id,traits,context,callback)},alias:function(from,to,context,callback){return client.alias(from,to,context,callback)},track:function(event,properties,context,callback){return client.track(event,properties,context,callback)},callback:function(data){if(transport.selected.name==="jsonp"&&data.callbackId){jsonp.callback(data.callbackId,data)}},logLevel:function(val){logger.setLevel(val)},verbose:function(verbose){if(verbose)logger.setLevel("verbose");else logger.setLevel("silent")},addLogger:function(logProvider){if(logProvider&&logProvider.log)logger.addLogger(logProvider)},baseUrl:function(url){client.config.baseUrl=url},client:function(callback){callback(client)}};api.init=api.initialize;var SegmentIO=function(queue){if(queue&&queue.length){for(var i=0;i<queue.length;i+=1){this.push(queue[i])}}};var genPublicMethod=function(methodName){return function(){this.push([methodName].concat(Array.prototype.slice.call(arguments,0)))}};var publicMethods=helpers.keys(api);for(var j=0;j<publicMethods.length;j+=1){SegmentIO.prototype[publicMethods[j]]=genPublicMethod(publicMethods[j])}SegmentIO.prototype.init=SegmentIO.prototype.initialize;SegmentIO.prototype.push=function(action){if(action){if(helpers.isArray(action)){var name=action.splice(0,1);if(api[name]){setTimeout(function(){try{api[name].apply(api,action)}catch(e){logger.log("error",false,"Internal error: "+e.stack)}},1)}else{logger.log("error",false,name+" is not a valid segment.io action.")}}else if(helpers.isFunction(action)){action()}}};DOMReady.wait(function(){if(window.seg){setTimeout(function(){window.segment=window.seg=new SegmentIO(window.seg)},100)}else if(window.segment){setTimeout(function(){window.segment=new SegmentIO(window.segment)},100)}})})();